name: Slack incoming-webhook PR Notifications
on:
  pull_request:
    types:
      - opened
      - closed
      - reopened
      - synchronize
      # - locked
      # - unlocked
      - edited 
      # - assigned
      # - unassigned
      # - labeled
      # - unlabeled
      - converted_to_draft
      - ready_for_review
      - review_requested
      - review_request_removed
  pull_request_review:
    types:
      - submitted
      - edited
      - dismissed
  pull_request_review_comment:
    types:
      - created
      - edited
      - deleted
  discussion:
    types:
      - created
      - edited
      - deleted
      - answered
      - unanswered
  discussion_comment:
    types:
      - created
      - edited
      - deleted

env:
  SLACK_CHANNEL: alpha-pr-review
  COLOR_PR_OPENED: "#28a745"
  COLOR_PR_MERGED: "#6f42c1"
  COLOR_PR_CLOSED: "#dc3545"
  COLOR_PR_REOPENED: "#ffc107"
  COLOR_PR_SYNCHRONIZED: "#17a2b8"
  COLOR_PR_REVIEW: "#007bff"
  COLOR_PR_COMMENT: "#28a745"
  COLOR_UNKNOWN: "#ffc107"

jobs:
  notify:
    environment:
      name: Production
    runs-on: ubuntu-latest
    steps:
      # For synchronize events, fetch the latest commit message using GitHub API
      - name: Get commit message for synchronize event
        if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
        id: get-commit-message
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the head commit SHA
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Use GitHub CLI to get commit info
          COMMIT_INFO=$(gh api repos/${{ github.repository }}/commits/${HEAD_SHA})
          
          # Extract the commit message
          COMMIT_MSG=$(echo $COMMIT_INFO | jq -r '.commit.message')
          
          # Escape newlines and other special chars for GitHub Actions
          COMMIT_MSG=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g')
          
          # Set output - save commit message in a way that handles multiline messages
          echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # For debugging
          echo "Retrieved commit message for SHA: ${HEAD_SHA}"

      - name: Set event message
        id: event-message
        run: |
          # Common PR details that will be included in most messages
          PR_DETAILS="*Title:* ${{ github.event.pull_request.title }}\n*Branch:* ${{ github.event.pull_request.head.ref }} → ${{ github.event.pull_request.base.ref }}\n*Author:* ${{ github.event.pull_request.user.login }}\n*Created:* $(date -d "${{ github.event.pull_request.created_at }}" "+%Y-%m-%d %H:%M:%S UTC")"
          
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "opened" ]]; then
            # Get PR body for description
            PR_BODY="${{ github.event.pull_request.body }}"
            # Truncate PR description to avoid too long messages
            TRUNCATED_BODY="${PR_BODY:0:200}${PR_BODY:200:+...}"
            
            # Details for new PR
            echo "MESSAGE=🟢 *New PR opened by ${{ github.event.pull_request.user.login }}*\n\n${PR_DETAILS}\n\n*Description:* ${TRUNCATED_BODY}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_OPENED }}" >> $GITHUB_ENV
            
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            # Details for merged PR
            MERGE_DETAILS="*Merged by:* ${{ github.event.sender.login }}\n*Merge time:* $(date -d "${{ github.event.pull_request.merged_at }}" "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=🟣 *PR merged by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${MERGE_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_MERGED }}" >> $GITHUB_ENV
            
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "closed" ]]; then
            # Details for closed PR without merging
            CLOSE_DETAILS="*Closed by:* ${{ github.event.sender.login }}\n*Close time:* $(date -d "${{ github.event.pull_request.closed_at }}" "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=🔴 *PR closed without merging by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${CLOSE_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_CLOSED }}" >> $GITHUB_ENV
            
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "reopened" ]]; then
            # Details for reopened PR
            REOPEN_DETAILS="*Reopened by:* ${{ github.event.sender.login }}\n*Reopen time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=🟡 *PR reopened by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${REOPEN_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_REOPENED }}" >> $GITHUB_ENV
            
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "synchronize" ]]; then
          # Details for new commits pushed to PR
          # Get the short commit SHA (first 7 characters)
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          
          SYNC_DETAILS="*Updated by:* ${{ github.event.sender.login }}\n*Update time:* $(date "+%Y-%m-%d %H:%M:%S UTC")\n*Latest commit:* \`${SHORT_SHA}\`"
          
          # Add the commit message from previous step
          if [[ -n "${{ env.COMMIT_MESSAGE }}" ]]; then
            # Truncate commit message to 150 chars
            COMMIT_MSG="${{ env.COMMIT_MESSAGE }}"
            TRUNCATED_COMMIT_MSG="${COMMIT_MSG:0:150}${COMMIT_MSG:150:+...}"
            SYNC_DETAILS="${SYNC_DETAILS}\n*Commit message:* ${TRUNCATED_COMMIT_MSG}"
          fi
          
          echo "MESSAGE=🔵 *PR updated with new commits by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${SYNC_DETAILS}" >> $GITHUB_ENV
          echo "COLOR=${{ env.COLOR_PR_SYNCHRONIZED }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "edited" ]]; then
            # Details for edited PR
            EDIT_DETAILS="*Edited by:* ${{ github.event.sender.login }}\n*Edit time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            # Check what was edited
            if [[ "${{ github.event.changes.title }}" != "" ]]; then
              EDIT_DETAILS="${EDIT_DETAILS}\n*Title changed:* ${{ github.event.changes.title.from }} → ${{ github.event.pull_request.title }}"
            fi
            if [[ "${{ github.event.changes.body }}" != "" ]]; then
              EDIT_DETAILS="${EDIT_DETAILS}\n*Description edited*"
            fi
            echo "MESSAGE=📝 *PR edited by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${EDIT_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "labeled" ]]; then
            # Details for added label
            LABEL_DETAILS="*Label added:* ${{ github.event.label.name }}\n*Added by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=🏷️ *Label added to PR by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${LABEL_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "unlabeled" ]]; then
            # Details for removed label
            LABEL_DETAILS="*Label removed:* ${{ github.event.label.name }}\n*Removed by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=🏷️ *Label removed from PR by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${LABEL_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "assigned" ]]; then
            # Details for assignment
            ASSIGN_DETAILS="*Assignee:* ${{ github.event.assignee.login }}\n*Assigned by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=👤 *PR assigned to ${{ github.event.assignee.login }} by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${ASSIGN_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "unassigned" ]]; then
            # Details for unassignment
            UNASSIGN_DETAILS="*Removed assignee:* ${{ github.event.assignee.login }}\n*Removed by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=👤 *PR unassigned from ${{ github.event.assignee.login }} by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${UNASSIGN_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "review_requested" ]]; then
            # Details for review request
            REVIEWER=""
            if [[ -n "${{ github.event.requested_reviewer.login }}" ]]; then
              REVIEWER="${{ github.event.requested_reviewer.login }}"
            elif [[ -n "${{ github.event.requested_team.name }}" ]]; then
              REVIEWER="team ${{ github.event.requested_team.name }}"
            fi
            REVIEW_DETAILS="*Reviewer:* ${REVIEWER}\n*Requested by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=👀 *Review requested from ${REVIEWER} by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${REVIEW_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_REVIEW }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "converted_to_draft" ]]; then
            # Details for draft conversion
            DRAFT_DETAILS="*Converted by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=📝 *PR converted to draft by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${DRAFT_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "ready_for_review" ]]; then
            # Details for ready for review
            READY_DETAILS="*Marked ready by:* ${{ github.event.sender.login }}\n*Time:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            echo "MESSAGE=✅ *PR marked ready for review by ${{ github.event.sender.login }}*\n\n${PR_DETAILS}\n\n${READY_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_OPENED }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request_review" && "${{ github.event.action }}" == "submitted" ]]; then
            # Details for PR review
            REVIEW_STATE="${{ github.event.review.state }}"
            REVIEW_ICON="💬"
            if [[ "${REVIEW_STATE}" == "approved" ]]; then
              REVIEW_ICON="✅"
            elif [[ "${REVIEW_STATE}" == "changes_requested" ]]; then
              REVIEW_ICON="❌"
            fi
            
            # Get truncated review body
            REVIEW_BODY="${{ github.event.review.body }}"
            TRUNCATED_REVIEW="${REVIEW_BODY:0:150}${REVIEW_BODY:150:+...}"
            
            REVIEW_DETAILS="*Reviewer:* ${{ github.event.review.user.login }}\n*State:* ${REVIEW_STATE}\n*Time:* $(date -d "${{ github.event.review.submitted_at }}" "+%Y-%m-%d %H:%M:%S UTC")"
            if [[ -n "${TRUNCATED_REVIEW}" ]]; then
              REVIEW_DETAILS="${REVIEW_DETAILS}\n*Comment:* ${TRUNCATED_REVIEW}"
            fi
            
            echo "MESSAGE=${REVIEW_ICON} *Review ${REVIEW_STATE} by ${{ github.event.review.user.login }}*\n\n${PR_DETAILS}\n\n${REVIEW_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_REVIEW }}" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            # Details for PR review comment
            # For comments, truncate them to a reasonable length
            COMMENT="${{ github.event.comment.body }}"
            TRUNCATED_COMMENT="${COMMENT:0:150}${COMMENT:150:+...}"
            
            COMMENT_DETAILS="*Commenter:* ${{ github.event.comment.user.login }}\n*Time:* $(date -d "${{ github.event.comment.created_at }}" "+%Y-%m-%d %H:%M:%S UTC")\n*Path:* ${{ github.event.comment.path }}${github.event.comment.line:+:${{ github.event.comment.line }}}"
            
            VERB="added"
            if [[ "${{ github.event.action }}" == "edited" ]]; then
              VERB="edited"
              COMMENT_DETAILS="${COMMENT_DETAILS}\n*Edited at:* $(date "+%Y-%m-%d %H:%M:%S UTC")"
            elif [[ "${{ github.event.action }}" == "deleted" ]]; then
              VERB="deleted"
            fi
            
            if [[ "${{ github.event.action }}" != "deleted" ]]; then
              COMMENT_DETAILS="${COMMENT_DETAILS}\n*Comment:* ${TRUNCATED_COMMENT}"
            fi
            
            echo "MESSAGE=💬 *PR comment ${VERB} by ${{ github.event.comment.user.login }}*\n\n${PR_DETAILS}\n\n${COMMENT_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_PR_COMMENT }}" >> $GITHUB_ENV
          else
            # Unknown events
            echo "MESSAGE=⚪ *${{ github.event.action }} event on PR*\n\n${PR_DETAILS}" >> $GITHUB_ENV
            echo "COLOR=${{ env.COLOR_UNKNOWN }}" >> $GITHUB_ENV
          fi

          # Set current Unix timestamp for the message
          echo "TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

      # Create payload file with simpler expressions
      - name: Create payload file
        id: create-payload
        run: |
          mkdir -p ./tmp
          cat > ./tmp/payload.json << EOF
          {
            "channel": "${{ env.SLACK_CHANNEL }}",
            "attachments": [
              {
                "color": "${{ env.COLOR }}",
                "pretext": "*${{ github.repository }}*",
                "title": "${{ github.event.pull_request.title }} #${{ github.event.pull_request.number }}",
                "title_link": "${{ github.event.pull_request.html_url }}",
                "text": "${{ env.MESSAGE }}",
                "footer": "GitHub Actions",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "mrkdwn_in": ["text", "pretext"],
                "ts": "${{ env.TIMESTAMP }}"
              }
            ]
          }
          EOF

      - name: Send to Slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          payload-file-path: ./tmp/payload.json
          payload-templated: true
          webhook: ${{ secrets.SLACK_INCOMING_WEBHOOK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          errors: true