name: Yarn Cache Check and Cleanup Triggerer Manually

on:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight
  workflow_dispatch:      # Manual trigger

jobs:
  yarn-cache-management:
    runs-on: [self-hosted-brazil, Linux]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Yarn Package Manager
        run: npm install -g yarn

      - name: Check Yarn Cache Size
        id: cache_size
        run: |
          CACHE_DIR=$(yarn cache dir)
          CACHE_SIZE_BYTES=$(du -sb $CACHE_DIR | awk '{print $1}')  # Get size in bytes
          CACHE_SIZE_HR=$(du -sh $CACHE_DIR | awk '{print $1}')      # Human-readable
          echo "Current Yarn cache size: $CACHE_SIZE_HR"
          echo "cache_size_bytes=$CACHE_SIZE_BYTES" >> $GITHUB_ENV
          echo "cache_size_hr=$CACHE_SIZE_HR" >> $GITHUB_ENV
          echo "::set-output name=cache_size_bytes::$CACHE_SIZE_BYTES"
          echo "::set-output name=cache_size_hr::$CACHE_SIZE_HR"
          echo "Yarn Cache Size: $CACHE_SIZE_HR" > yarn_cache_report.txt

      - name: Analyze Yarn Cache
        run: |
          echo "Performing Yarn cache analysis..." >> yarn_cache_report.txt
          yarn cache list >> yarn_cache_report.txt

      - name: Clear Yarn Cache if Threshold Exceeded
        if: ${{ steps.cache_size.outputs.cache_size_bytes > 500000000 }}  # 500MB in bytes
        run: |
          echo "Cache size exceeds 500MB. Clearing cache..." >> yarn_cache_report.txt
          yarn cache clean
          echo "Yarn cache cleared." >> yarn_cache_report.txt

      - name: Display Post-Cleanup Cache Size
        run: |
          CACHE_DIR=$(yarn cache dir)
          CACHE_SIZE_HR=$(du -sh $CACHE_DIR | awk '{print $1}')
          echo "Post-cleanup Yarn cache size: $CACHE_SIZE_HR"
          echo "Post-cleanup Yarn cache size: $CACHE_SIZE_HR" >> yarn_cache_report.txt

      - name: Upload Yarn Cache Report
        uses: actions/upload-artifact@v4
        with:
          name: cache-size-${{ env.cache_size_hr }}
          path: yarn_cache_report.txt
          retention-days: 7
